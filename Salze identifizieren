<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Labortisch ‚Äì Nachweis-Spiel (Lern/Experte)</title>
<style>
  :root{
    --bg:#0b1020; --line:#223055; --text:#e8eefc; --muted:#a9b3cc;
    --wood1:#6b4e2e; --wood2:#5a3f25;
    --glass: rgba(255,255,255,.12); --glassLine: rgba(255,255,255,.42);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background: radial-gradient(1100px 700px at 20% 0%, #1a2a58 0%, var(--bg) 55%);
    color:var(--text);
  }
  header{
    position:sticky; top:0; z-index:30;
    padding:12px 14px;
    background: linear-gradient(180deg, rgba(16,26,51,.96), rgba(16,26,51,.78));
    border-bottom:1px solid var(--line);
    backdrop-filter: blur(8px);
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  header h1{font-size:14px; margin:0; font-weight:750}
  .chip{
    font-size:12px; color:var(--muted);
    border:1px solid var(--line);
    background: rgba(2,6,23,.35);
    padding:6px 10px; border-radius:999px;
    display:inline-flex; gap:8px; align-items:center;
  }
  .chip b{color:var(--text)}

  .wrap{
    max-width: 1200px; margin:0 auto; padding:12px;
    display:grid; grid-template-columns: 380px 1fr; gap:12px;
  }
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }

  .panel{
    background: linear-gradient(180deg, rgba(16,26,51,.90), rgba(8,14,30,.92));
    border:1px solid var(--line);
    border-radius:14px;
    overflow:hidden;
    box-shadow: 0 14px 34px rgba(0,0,0,.25);
  }
  .hd{
    padding:10px 12px; border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .hd h2{margin:0; font-size:13px; font-weight:800; color:#dbeafe}
  .bd{padding:12px}
  .small{font-size:12px; color:var(--muted); line-height:1.45}

  .btnrow{display:flex; gap:10px; flex-wrap:wrap}
  .btn{
    font: inherit; font-size:13px;
    padding:10px 10px; border-radius:12px;
    border:1px solid rgba(96,165,250,.45);
    background: rgba(96,165,250,.16);
    color: var(--text);
    cursor:pointer; user-select:none;
    transition: transform .06s ease, background .15s ease;
    display:inline-flex; align-items:center; gap:8px;
    line-height:1;
  }
  .btn:hover{background: rgba(96,165,250,.22)}
  .btn:active{transform: translateY(1px)}
  .btn.secondary{border-color: rgba(169,179,204,.30); background: rgba(169,179,204,.10)}
  .btn.danger{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12)}

  .station{
    border:1px dashed rgba(169,179,204,.40);
    background: rgba(2,6,23,.22);
    border-radius:16px;
    padding:10px;
    position:relative;
  }
  .station h3{margin:0 0 8px 0; font-size:12px; color:#dbeafe}

  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .itemBtn{
    border:1px solid rgba(34,48,85,.95);
    background: rgba(2,6,23,.25);
    border-radius: 14px;
    padding:10px;
    cursor:pointer;
    user-select:none;
    transition: transform .06s ease, background .12s ease, border-color .12s ease;
    text-align:left;
  }
  .itemBtn:hover{background: rgba(2,6,23,.35)}
  .itemBtn:active{transform: translateY(1px)}
  .itemBtn.active{
    outline: 2px solid rgba(96,165,250,.75);
    border-color: rgba(96,165,250,.75);
    box-shadow: 0 0 0 4px rgba(96,165,250,.18);
  }
  .itemBtn small{color:var(--muted)}
  .itemBtn .formula{color:#ffffff; font-weight:800}

  .log{
    margin-top:12px; max-height: 250px; overflow:auto;
    border:1px solid rgba(34,48,85,.95);
    background: rgba(2,6,23,.32);
    border-radius:14px;
    padding:10px; font-size:12px; line-height:1.35;
  }
  .log .ok{color: rgba(34,197,94,.95)}
  .log .bad{color: rgba(239,68,68,.95)}
  .log .warn{color: rgba(245,158,11,.95)}
  .log .muted{color: var(--muted)}

  .bench{
    border-top:1px solid var(--line);
    background:
      linear-gradient(180deg, rgba(8,14,30,.25), rgba(8,14,30,.60)),
      repeating-linear-gradient(90deg, var(--wood1) 0 30px, var(--wood2) 30px 60px);
    border-radius: 0 0 14px 14px;
    padding:12px;
    position: relative;
    min-height: 610px;
    overflow:hidden;
  }

  /* (4) Brenner neben dem Tisch: zwei Spalten im Arbeitsbereich */
  .benchGrid{
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:12px;
    align-items:start;
    position: relative;
    z-index: 1;
  }
  @media (max-width: 980px){
    .benchGrid{grid-template-columns:1fr}
  }

  /* tube */
  .tubeWrap{display:flex; justify-content:center; padding:10px 0}
  .tube{
    position:relative;
    width: 120px; height: 210px;
    border:2px solid var(--glassLine);
    border-top-left-radius: 18px; border-top-right-radius: 18px;
    border-bottom-left-radius: 56px 40px; border-bottom-right-radius: 56px 40px;
    background: var(--glass);
    overflow:hidden;
    cursor:pointer;
  }
  .tube .liquid{
    position:absolute; left:0; right:0; bottom:0;
    height: 0%;
    background: rgba(147,197,253,.18);
    border-top:1px solid rgba(147,197,253,.35);
    transition: height .25s ease, background .25s ease;
    z-index:1;
  }
  .tube .precip{
    position:absolute; left:0; right:0; bottom:0;
    height: 0%;
    background: rgba(255,255,255,.35);
    transition: height .25s ease, background .35s ease;
    z-index:2;
  }
  .tube .saltPile{
    position:absolute; left:0; right:0; bottom:0;
    height: 0%;
    pointer-events:none;
    z-index:3;
    transition: height .18s ease;
  }
  .grain{
    position:absolute;
    width: 8px; height: 8px;
    border-radius: 2px;
    background: rgba(255,255,255,.95);
    box-shadow: 0 1px 0 rgba(0,0,0,.25);
    opacity:.98;
  }
  .tubeCaption{ text-align:center; font-size:11px; color:var(--muted); }
  .miniBtn{
    position:absolute; right:10px; top:10px;
    border:1px solid rgba(169,179,204,.35);
    background: rgba(2,6,23,.35);
    color: var(--text);
    border-radius: 10px;
    font-size:12px;
    padding:6px 8px;
    cursor:pointer;
    user-select:none;
    z-index:10;
  }

  /* plate */
  .plateGrid{
    /* (3) wieder ordentlich nebeneinander */
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
    justify-items:center;
    align-items:center;
    padding:10px 6px;
    max-width: 340px;
    margin: 0 auto;
  }
  .wellWrap{position:relative}
  .wellReset{
    position:absolute; top:-6px; right:-6px;
    width: 22px; height: 22px;
    border-radius:999px;
    border:1px solid rgba(169,179,204,.35);
    background: rgba(2,6,23,.45);
    color: var(--text);
    font-size:12px;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    z-index:5;
  }
  .well{
    width: 64px; height: 64px;
    border-radius: 999px;
    border:2px solid rgba(226,232,240,.35);
    background: rgba(255,255,255,.06);
    position:relative; overflow:hidden;
    cursor:pointer;
  }
  .well .fluid{position:absolute; inset:0; background:transparent; transition: background .2s ease; z-index:1;}
  .well .salt{position:absolute; inset:0; opacity:0; transition: opacity .12s ease; z-index:2;}
  .well .tag{
    position:absolute; left:0; right:0; bottom:4px;
    text-align:center;
    font-size:10px; color: rgba(229,231,235,.92);
    text-shadow: 0 1px 0 rgba(0,0,0,.35);
    z-index:3; pointer-events:none;
  }

  /* burner */
  .burnerArea{
    position:relative;
    height: 330px;
    border-radius: 16px;
    border:1px solid rgba(34,48,85,.95);
    background: radial-gradient(520px 240px at 50% 120%, rgba(96,165,250,.16) 0%, rgba(2,6,23,.30) 55%, rgba(2,6,23,.48) 100%);
    overflow:hidden;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    padding-bottom:22px;
    cursor:pointer;
    user-select:none;
  }
  .burnerSvg{width: 280px; height: 220px; pointer-events:none; z-index:2;}
  .flame{
    position:absolute;
    left:50%;
    transform: translateX(-50%);
    bottom: 130px;
    width: 86px;
    height: 150px;
    opacity:0;
    transition: opacity .16s ease;
    pointer-events:none;
    filter: drop-shadow(0 14px 18px rgba(0,0,0,.30));
    z-index:3;
  }
  .flame.on{opacity:1}
  .flame::before, .flame::after{
    content:"";
    position:absolute; inset:0;
    border-radius: 60% 60% 70% 70% / 55% 55% 85% 85%;
    animation: flicker 0.12s infinite alternate;
  }
  .flame::before{
    background:
      radial-gradient(circle at 50% 28%, rgba(255,255,255,.95) 0 16%, rgba(147,197,253,.98) 17% 48%, rgba(59,130,246,.55) 49% 100%);
  }
  .flame::after{
    inset: 16px 20px 44px 20px;
    background:
      radial-gradient(circle at 50% 30%, rgba(255,255,255,.95) 0 22%, rgba(191,219,254,.88) 23% 58%, rgba(96,165,250,.35) 59% 100%);
    filter: blur(0.4px);
    animation-duration: 0.10s;
  }
  @keyframes flicker{ from{ transform: rotate(-2deg) scaleY(1.00) } to{ transform: rotate( 2deg) scaleY(1.03) } }

  .flameTint{
    position:absolute;
    left:50%;
    transform: translateX(-50%);
    bottom: 140px;
    width: 98px;
    height: 160px;
    opacity:0;
    transition: opacity .10s ease;
    pointer-events:none;
    mix-blend-mode: screen;
    z-index:4;
    border-radius: 60% 60% 70% 70% / 55% 55% 85% 85%;
  }
  .flameTint.show{opacity:.92}

  /* draggable tool overlay */
  .toolStage{
    position:absolute;
    inset:0;
    z-index: 2;
    pointer-events:none;
  }
  .tool{
    position:absolute;
    width: 190px;
    height: 64px;
    border-radius: 16px;
    border:1px solid rgba(34,48,85,.95);
    background: rgba(2,6,23,.30);
    backdrop-filter: blur(6px);
    box-shadow: 0 10px 20px rgba(0,0,0,.25);
    display:flex; gap:10px; align-items:center; padding:10px;
    user-select:none;
    touch-action:none;
    pointer-events:auto;
    cursor: grab;
    z-index: 5;
  }
  .tool:active{cursor: grabbing}
  .tool .icon{
    width:44px; height:44px; border-radius: 12px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(226,232,240,.14);
    display:flex; align-items:center; justify-content:center;
    flex: 0 0 auto;
  }
  .tool .lbl{display:flex; flex-direction:column; gap:2px}
  .tool .lbl b{font-size:12px}
  .tool .lbl small{font-size:10px; color:var(--muted)}
  .tool.selected{ outline: 2px solid rgba(96,165,250,.75); }

  /* expert box */
  .expertBox{
    margin-top:12px;
    border:1px solid rgba(34,48,85,.95);
    background: rgba(2,6,23,.26);
    border-radius: 14px;
    padding:10px;
    display:none;
  }
  .expertBox.show{display:block}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  input[type="text"]{
    background: rgba(2,6,23,.35);
    color: var(--text);
    border:1px solid rgba(34,48,85,.95);
    border-radius: 12px;
    padding:10px;
    font: inherit;
    font-size:13px;
    width: min(320px, 100%);
  }
</style>
</head>

<body>
<header>
  <h1>Labortisch: Nachweis-Spiel</h1>
  <span class="chip">Modus: <b id="modeLabel">Lernmodus</b></span>
  <span class="chip">Auswahl: <b id="selLabel">‚Äî</b></span>
  <span class="chip">Werkzeug: <b id="toolLabel">‚Äî</b></span>
  <span class="chip">Brenner: <b id="burnerLabel">aus</b></span>
</header>

<div class="wrap">
  <section class="panel">
    <div class="hd">
      <h2>Steuerung</h2>
      <div class="btnrow">
        <button class="btn" id="btnMode">Zu Expertenmodus</button>
        <button class="btn secondary" id="btnClearSel">Auswahl aufheben</button>
        <button class="btn danger" id="btnResetAll">Alles zur√ºcksetzen</button>
      </div>
    </div>
    <div class="bd">
      <div class="small">
        Salz anklicken ‚Üí Reagenzglas/Mulde anklicken (Kristalle erscheinen).<br>
        Werkzeuge: ziehen & √ºber Ziel loslassen (Wasser/AgNO‚ÇÉ √ºber Reagenzglas, HCl √ºber Mulde, MgO √ºber Mulde/Flamme).<br>
        Brenner: anklicken (an/aus).<br>
        <span class="muted">(Experte: Unbekannt A ist nicht beschriftet ‚Äì identifizieren Sie es √ºber Nachweise.)</span>
      </div>

      <div class="station" style="margin-top:12px;">
        <h3>Salze</h3>
        <div class="grid2" id="saltList">
          <button class="itemBtn" data-salt="NaCl">üßÇ <span class="formula">NaCl</span><br><small>Natriumchlorid</small></button>
          <button class="itemBtn" data-salt="LiBr">üßÇ <span class="formula">LiBr</span><br><small>Lithiumbromid</small></button>
          <button class="itemBtn" data-salt="CsI">üßÇ <span class="formula">CsI</span><br><small>C√§siumiodid</small></button>
          <button class="itemBtn" data-salt="Ba3(AsO4)2">üßÇ <span class="formula">Ba‚ÇÉ(AsO‚ÇÑ)‚ÇÇ</span><br><small>Bariumarsenat</small></button>

          <button class="itemBtn" data-salt="SrI2">üßÇ <span class="formula">SrI‚ÇÇ</span><br><small>Strontiumiodid</small></button>
          <button class="itemBtn" data-salt="KBr">üßÇ <span class="formula">KBr</span><br><small>Kaliumbromid</small></button>
          <button class="itemBtn" data-salt="CaCl2">üßÇ <span class="formula">CaCl‚ÇÇ</span><br><small>Calciumchlorid</small></button>
          <button class="itemBtn" data-salt="CuCl2">üßÇ <span class="formula">CuCl‚ÇÇ</span><br><small>Kupferchlorid</small></button>

          <button class="itemBtn" id="unknownBtn" data-salt="UNKNOWN" style="display:none;">
            ‚ùì <span class="formula">Unbekannt A</span><br><small>Expertenprobe</small>
          </button>
        </div>
      </div>

      <div class="expertBox" id="expertBox">
        <div class="row" style="margin-bottom:8px;">
          <button class="btn secondary" id="btnNewUnknown">Neue Expertenprobe (Unbekannt A)</button>
        </div>
        <div class="row">
          <label class="small" for="guessInput">Ihr L√∂sungsvorschlag (Name):</label>
          <input id="guessInput" type="text" placeholder="z. B. Natriumchlorid" autocomplete="off" />
          <button class="btn" id="btnCheck">Pr√ºfen</button>
        </div>
        <div class="small" style="margin-top:8px; color:#cbd5e1;">
          Eingabe ist nicht case-sensitiv; Bindestriche/Leerzeichen werden tolerant behandelt. Beispiel: ‚ÄûKupferiodid‚Äú.
        </div>
      </div>

      <div class="log" id="log"></div>
    </div>
  </section>

  <section class="panel">
    <div class="hd"><h2>Labortisch</h2></div>
    <div class="bench" id="bench">
      <div class="toolStage" id="toolStage"></div>

      <!-- (4) Brenner rechts neben dem Tisch (nicht darunter) -->
      <div class="benchGrid">
        <!-- linke Spalte: Tisch (Tube + T√ºpfelplatte) -->
        <div style="display:grid; gap:12px;">
          <div class="station">
            <h3>Reagenzglas (AgNO‚ÇÉ)</h3>
            <button class="miniBtn" id="btnResetTube" title="Nur Reagenzglas zur√ºcksetzen">‚Ü∫ Tube</button>
            <div class="tubeWrap">
              <div>
                <div class="tube" id="tube" title="Klick: Salz einf√ºllen">
                  <div class="precip" id="tubePrecip"></div>
                  <div class="liquid" id="tubeLiquid"></div>
                  <div class="saltPile" id="tubeSaltPile"></div>
                </div>
                <div class="tubeCaption">Kristalle sind vor dem L√∂sen sichtbar.</div>
              </div>
            </div>
          </div>

          <div class="station">
            <h3>T√ºpfelplatte (Flammenprobe)</h3>
            <div class="plateGrid" id="plate">
              <div class="wellWrap">
                <div class="wellReset" data-wreset="0">‚Ü∫</div>
                <div class="well" data-well="0"><div class="fluid"></div><div class="salt"></div><div class="tag">Feld 1</div></div>
              </div>
              <div class="wellWrap">
                <div class="wellReset" data-wreset="1">‚Ü∫</div>
                <div class="well" data-well="1"><div class="fluid"></div><div class="salt"></div><div class="tag">Feld 2</div></div>
              </div>
              <div class="wellWrap">
                <div class="wellReset" data-wreset="2">‚Ü∫</div>
                <div class="well" data-well="2"><div class="fluid"></div><div class="salt"></div><div class="tag">Feld 3</div></div>
              </div>
              <div class="wellWrap">
                <div class="wellReset" data-wreset="3">‚Ü∫</div>
                <div class="well" data-well="3"><div class="fluid"></div><div class="salt"></div><div class="tag">Feld 4</div></div>
              </div>
            </div>
            <div class="tubeCaption">HCl √ºber Mulde ‚Üí l√∂sen. MgO √ºber Mulde ‚Üí tauchen. MgO √ºber Flamme ‚Üí Farbe.</div>
          </div>
        </div>

        <!-- rechte Spalte: Brenner -->
        <div style="display:grid; gap:12px;">
          <div class="station">
            <h3>Brenner (anklicken = an/aus)</h3>
            <div class="burnerArea" id="burnerArea">
              <div class="flame" id="flame"></div>
              <div class="flameTint" id="flameTint"></div>
              <svg class="burnerSvg" viewBox="0 0 280 240" aria-label="Bunsenbrenner">
                <ellipse cx="140" cy="210" rx="90" ry="18" fill="rgba(15,23,42,.55)" stroke="rgba(226,232,240,.25)" stroke-width="2"/>
                <rect x="85" y="165" width="110" height="45" rx="12" fill="rgba(148,163,184,.20)" stroke="rgba(226,232,240,.28)" stroke-width="2"/>
                <rect x="124" y="55" width="32" height="120" rx="14" fill="rgba(226,232,240,.14)" stroke="rgba(226,232,240,.28)" stroke-width="2"/>
                <rect x="118" y="35" width="44" height="24" rx="10" fill="rgba(226,232,240,.14)" stroke="rgba(226,232,240,.28)" stroke-width="2"/>
              </svg>
            </div>
            <div class="small" style="margin-top:10px;" id="statusText">Bereit.</div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = (q,root=document)=>root.querySelector(q);
  const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));

  const modeLabel = $("#modeLabel");
  const selLabel = $("#selLabel");
  const toolLabel = $("#toolLabel");
  const burnerLabel = $("#burnerLabel");
  const statusText = $("#statusText");
  const logEl = $("#log");

  const bench = $("#bench");
  const toolStage = $("#toolStage");

  const tube = $("#tube");
  const tubeLiquid = $("#tubeLiquid");
  const tubePrecip = $("#tubePrecip");
  const tubeSaltPile = $("#tubeSaltPile");

  const burnerArea = $("#burnerArea");
  const flame = $("#flame");
  const flameTint = $("#flameTint");

  const btnMode = $("#btnMode");
  const btnClearSel = $("#btnClearSel");
  const btnResetAll = $("#btnResetAll");
  const btnResetTube = $("#btnResetTube");

  const unknownBtn = $("#unknownBtn");
  const expertBox = $("#expertBox");
  const btnNewUnknown = $("#btnNewUnknown");
  const btnCheck = $("#btnCheck");
  const guessInput = $("#guessInput");

  function log(html){
    const d=document.createElement("div");
    d.innerHTML=html;
    logEl.appendChild(d);
    logEl.scrollTop=logEl.scrollHeight;
  }
  function setStatus(s){ statusText.textContent = s; }

  const SUB = {"0":"‚ÇÄ","1":"‚ÇÅ","2":"‚ÇÇ","3":"‚ÇÉ","4":"‚ÇÑ","5":"‚ÇÖ","6":"‚ÇÜ","7":"‚Çá","8":"‚Çà","9":"‚Çâ"};
  function subNum(n){
    const s=String(n);
    return s.split("").map(ch=>SUB[ch]||ch).join("");
  }

  const SALTS = {
    "NaCl": {name:"Natriumchlorid",      cationSym:"Na‚Å∫",  anionSym:"Cl‚Åª",    ag:"white",    flame:"gelb"},
    "LiBr": {name:"Lithiumbromid",       cationSym:"Li‚Å∫",  anionSym:"Br‚Åª",    ag:"cream",    flame:"karminrot"},
    "CsI":  {name:"C√§siumiodid",         cationSym:"Cs‚Å∫",  anionSym:"I‚Åª",     ag:"yellow",   flame:"blauviolett"},
    "Ba3(AsO4)2": {name:"Bariumarsenat", cationSym:"Ba¬≤‚Å∫", anionSym:"AsO‚ÇÑ¬≥‚Åª", ag:"arsenate", flame:"apfelgr√ºn"},
    "SrI2": {name:"Strontiumiodid",      cationSym:"Sr¬≤‚Å∫", anionSym:"I‚Åª",     ag:"yellow",   flame:"rot"},
    "KBr":  {name:"Kaliumbromid",        cationSym:"K‚Å∫",   anionSym:"Br‚Åª",    ag:"cream",    flame:"violett"},
    "CaCl2":{name:"Calciumchlorid",      cationSym:"Ca¬≤‚Å∫", anionSym:"Cl‚Åª",    ag:"white",    flame:"ziegelrot"},
    /* (1) Kupfer ohne Oxidationszahl */
    "CuCl2":{name:"Kupferchlorid",       cationSym:"Cu¬≤‚Å∫", anionSym:"Cl‚Åª",    ag:"white",    flame:"blaugr√ºn"}
  };

  const AG_BG = {
    white:  "rgba(255,255,255,.42)",
    cream:  "rgba(253,230,138,.40)",
    yellow: "rgba(250,204,21,.42)"
  };

  const FLAME_TINT = {
    "gelb":"radial-gradient(circle at 50% 32%, rgba(255,255,255,.90) 0 18%, rgba(250,204,21,.92) 19% 58%, rgba(245,158,11,.45) 59% 100%)",
    "karminrot":"radial-gradient(circle at 50% 32%, rgba(255,255,255,.90) 0 18%, rgba(248,113,113,.95) 19% 58%, rgba(239,68,68,.45) 59% 100%)",
    "rot":"radial-gradient(circle at 50% 32%, rgba(255,255,255,.90) 0 18%, rgba(239,68,68,.92) 19% 58%, rgba(220,38,38,.45) 59% 100%)",
    "blauviolett":"radial-gradient(circle at 50% 32%, rgba(255,255,255,.90) 0 18%, rgba(167,139,250,.95) 19% 58%, rgba(139,92,246,.45) 59% 100%)",
    "violett":"radial-gradient(circle at 50% 32%, rgba(255,255,255,.90) 0 18%, rgba(196,181,253,.95) 19% 58%, rgba(167,139,250,.45) 59% 100%)",
    "apfelgr√ºn":"radial-gradient(circle at 50% 32%, rgba(255,255,255,.90) 0 18%, rgba(74,222,128,.92) 19% 58%, rgba(34,197,94,.45) 59% 100%)",
    "ziegelrot":"radial-gradient(circle at 50% 32%, rgba(255,255,255,.90) 0 18%, rgba(251,146,60,.92) 19% 58%, rgba(234,88,12,.45) 59% 100%)",
    "blaugr√ºn":"radial-gradient(circle at 50% 32%, rgba(255,255,255,.90) 0 18%, rgba(45,212,191,.92) 19% 58%, rgba(20,184,166,.45) 59% 100%)"
  };

  /* (1) Kupfer generell als Cu2+, aber Name ohne (II) */
  const CATIONS = [
    {key:"Na", name:"Natrium",   sym:"Na", charge:1},
    {key:"Li", name:"Lithium",   sym:"Li", charge:1},
    {key:"Cs", name:"C√§sium",    sym:"Cs", charge:1},
    {key:"K",  name:"Kalium",    sym:"K",  charge:1},
    {key:"Ba", name:"Barium",    sym:"Ba", charge:2},
    {key:"Sr", name:"Strontium", sym:"Sr", charge:2},
    {key:"Ca", name:"Calcium",   sym:"Ca", charge:2},
    {key:"Cu", name:"Kupfer",    sym:"Cu", charge:2}
  ];
  const ANIONS = [
    {key:"Cl",  name:"chlorid",  sym:"Cl",  charge:1, ag:"white"},
    {key:"Br",  name:"bromid",   sym:"Br",  charge:1, ag:"cream"},
    {key:"I",   name:"iodid",    sym:"I",   charge:1, ag:"yellow"},
    {key:"AsO4",name:"arsenat",  sym:"AsO4",charge:3, ag:"arsenate", poly:true}
  ];

  function gcd(a,b){ while(b){ [a,b]=[b,a%b]; } return a; }
  function lcm(a,b){ return (a*b)/gcd(a,b); }

  function formatFormula(c, a){
    const L = lcm(c.charge, a.charge);
    const nC = L / c.charge;
    const nA = L / a.charge;

    const cPart = c.sym + (nC>1 ? subNum(nC) : "");
    let aCore = a.sym;
    if (a.poly && nA>1) aCore = "(" + aCore.replace("O4","O‚ÇÑ") + ")";
    else if (a.sym==="AsO4") aCore = "AsO‚ÇÑ";
    const aPart = aCore + (nA>1 ? subNum(nA) : "");
    return cPart + aPart;
  }

  /* (1) Name ohne Oxidationszahl: Kupferiodid, Kupferchlorid, etc. */
  function canonicalSaltName(c, a){
    const cat = c.name;
    const an  = a.name;
    return cat + an;
  }

  function normalizeName(s){
    return (s||"")
      .trim()
      .toLowerCase()
      .replace(/√§/g,"ae").replace(/√∂/g,"oe").replace(/√º/g,"ue").replace(/√ü/g,"ss")
      .replace(/[‚Äê-‚Äì‚Äî-]/g,"-")
      .replace(/\s+/g,"")
      .replace(/[^a-z0-9()\-]/g,"");
  }

  const FLAME_BY_CATION_KEY = {
    Na:"gelb",
    Li:"karminrot",
    Cs:"blauviolett",
    K:"violett",
    Ba:"apfelgr√ºn",
    Sr:"rot",
    Ca:"ziegelrot",
    Cu:"blaugr√ºn"
  };

  const STATE = {
    mode: "learn",
    selectedSalt: null,
    unknownActual: null,

    burnerOn: false,

    tube: {has:false, saltId:null, unknown:false, dissolved:false, ag:false, arsenateTimer:null},
    wells: Array.from({length:4}, ()=>({has:false, saltId:null, unknown:false, hcl:false})),
    mgoDipped: null,
    activeToolId: null
  };

  function updateTop(){
    modeLabel.textContent = (STATE.mode==="learn") ? "Lernmodus" : "Expertenmodus";
    burnerLabel.textContent = STATE.burnerOn ? "an" : "aus";
    flame.classList.toggle("on", STATE.burnerOn);
    if (!STATE.burnerOn) flameTint.classList.remove("show");

    if (!STATE.selectedSalt){
      selLabel.textContent = "‚Äî";
    } else if (STATE.selectedSalt==="UNKNOWN"){
      selLabel.textContent = "Unbekannt A";
    } else {
      selLabel.textContent = STATE.selectedSalt;
    }
    toolLabel.textContent = STATE.activeToolId || "‚Äî";
  }

  function labelForPlacement(isUnknown, saltId){
    if (isUnknown) return "Unbekannt A";
    return saltId;
  }

  burnerArea.addEventListener("click", ()=>{
    STATE.burnerOn = !STATE.burnerOn;
    flameTint.classList.remove("show");
    setStatus(STATE.burnerOn ? "Brenner an" : "Brenner aus");
    updateTop();
  });

  function renderGrains(container, count, w, h){
    container.innerHTML = "";
    for (let i=0;i<count;i++){
      const g=document.createElement("div");
      g.className="grain";
      const size = (Math.random()<0.22) ? 10 : 8;
      g.style.width=size+"px";
      g.style.height=size+"px";
      const x = 10 + Math.random()*(w-20-size);
      const y = 6 + Math.random()*(h-12-size);
      g.style.left = x + "px";
      g.style.top  = y + "px";
      g.style.transform = `rotate(${Math.random()*50-25}deg)`;
      container.appendChild(g);
    }
  }

  function renderTubeSalt(show){
    tubeSaltPile.style.height = show ? "18%" : "0%";
    if (!show){ tubeSaltPile.innerHTML=""; return; }
    const pileH = Math.max(30, Math.floor(tube.clientHeight * 0.18));
    const pileW = tube.clientWidth;
    tubeSaltPile.style.height = pileH + "px";
    renderGrains(tubeSaltPile, 56, pileW, pileH);
  }

  function renderWellSalt(i){
    const well = $(`.well[data-well="${i}"]`);
    const salt = $(".salt", well);
    salt.style.opacity="1";
    renderGrains(salt, 28, well.clientWidth, well.clientHeight);
  }

  function setWellTag(i){
    const well = $(`.well[data-well="${i}"]`);
    const tag  = $(".tag", well);
    const w = STATE.wells[i];
    if (!w.has){ tag.textContent = `Feld ${i+1}`; return; }
    const base = labelForPlacement(w.unknown, w.saltId);
    tag.textContent = base + (w.hcl ? " ‚Ä¢ HCl" : "");
  }

  function stopArsenate(){
    if (STATE.tube.arsenateTimer){
      clearInterval(STATE.tube.arsenateTimer);
      STATE.tube.arsenateTimer=null;
    }
  }
  function resetTube(){
    stopArsenate();
    STATE.tube = {has:false, saltId:null, unknown:false, dissolved:false, ag:false, arsenateTimer:null};
    tubeLiquid.style.height="0%";
    tubeLiquid.style.background="rgba(147,197,253,.18)";
    tubePrecip.style.height="0%";
    tubePrecip.style.background="rgba(255,255,255,.35)";
    renderTubeSalt(false);
  }

  btnResetTube.addEventListener("click",(ev)=>{
    ev.stopPropagation();
    resetTube();
    setStatus("Reagenzglas: leer");
    log(`<span class="muted">Reagenzglas zur√ºckgesetzt.</span>`);
  });

  function pickUnknown(){
    const c = CATIONS[Math.floor(Math.random()*CATIONS.length)];
    const a = ANIONS[Math.floor(Math.random()*ANIONS.length)];
    const formula = formatFormula(c, a);
    const name = canonicalSaltName(c, a);
    const ag = a.ag;
    const flame = FLAME_BY_CATION_KEY[c.key] || "gelb";
    STATE.unknownActual = {cation:c, anion:a, formula, name, ag, flame};
    log(`<span class="muted">Unbekannt A wurde neu gew√§hlt.</span>`);
  }

  btnMode.addEventListener("click", ()=>{
    STATE.mode = (STATE.mode==="learn") ? "expert" : "learn";
    const exp = (STATE.mode==="expert");
    unknownBtn.style.display = exp ? "" : "none";
    expertBox.classList.toggle("show", exp);
    btnMode.textContent = exp ? "Zu Lernmodus" : "Zu Expertenmodus";
    if (exp){
      pickUnknown();
      setStatus("Expertenmodus: Unbekannt A bereit.");
    } else {
      setStatus("Lernmodus: Bereit.");
    }
    updateTop();
    log(`<span class="muted">Modus:</span> <b>${exp ? "Experte" : "Lernmodus"}</b>`);
  });

  btnNewUnknown.addEventListener("click", ()=>{
    if (STATE.mode!=="expert"){ log(`<span class="warn">Nur im Expertenmodus.</span>`); return; }
    pickUnknown();
  });

  function revealUnknownAfterCorrect(){
    const u = STATE.unknownActual;
    log(`<span class="ok">Richtig.</span> Unbekannt A ist <b>${u.name}</b> (<b>${u.formula}</b>).`);
    setStatus(`Richtig: ${u.name} (${u.formula}). Neue Probe folgt...`);
    pickUnknown();
    guessInput.value = "";
    guessInput.focus();
    setTimeout(()=>setStatus("Neue Expertenprobe: Unbekannt A bereit."), 650);
  }

  btnCheck.addEventListener("click", ()=>{
    if (STATE.mode!=="expert"){
      log(`<span class="warn">Pr√ºfen gibt es nur im Expertenmodus.</span>`);
      return;
    }
    const u = STATE.unknownActual;
    if (!u){
      log(`<span class="warn">Unbekannt A ist noch nicht gesetzt.</span>`);
      return;
    }
    const guess = normalizeName(guessInput.value);
    if (!guess){
      log(`<span class="warn">Bitte einen Salznamen eingeben.</span>`);
      return;
    }
    const target = normalizeName(u.name);
    const ok = (guess===target);
    if (ok){
      revealUnknownAfterCorrect();
    } else {
      log(`<span class="bad">Falsch.</span> Bitte weiter analysieren und erneut versuchen.`);
      setStatus("Falsch: Analyse fortsetzen.");
      guessInput.select();
    }
  });

  guessInput.addEventListener("keydown", (ev)=>{
    if (ev.key==="Enter") btnCheck.click();
  });

  function setSelected(id, btn){
    STATE.selectedSalt = id;
    $$("#saltList .itemBtn").forEach(b=>b.classList.toggle("active", b===btn));
    if (id==="UNKNOWN"){
      log(`<span class="muted">Auswahl:</span> <b>Unbekannt A</b>`);
    } else {
      log(`<span class="muted">Auswahl:</span> <b>${id}</b> (${SALTS[id].name})`);
    }
    updateTop();
  }

  $$("#saltList .itemBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      setSelected(btn.dataset.salt, btn);
    });
  });

  btnClearSel.addEventListener("click", ()=>{
    STATE.selectedSalt=null;
    $$("#saltList .itemBtn").forEach(b=>b.classList.remove("active"));
    updateTop();
    log(`<span class="muted">Auswahl aufgehoben.</span>`);
  });

  function selectedActualSaltId(){
    if (!STATE.selectedSalt) return null;
    if (STATE.selectedSalt==="UNKNOWN") return null;
    return STATE.selectedSalt;
  }

  tube.addEventListener("click", ()=>{
    if (!STATE.selectedSalt){
      log(`<span class="warn">Zuerst ein Salz ausw√§hlen.</span>`);
      return;
    }
    if (STATE.tube.has){
      log(`<span class="warn">Im Reagenzglas ist bereits eine Probe.</span>`);
      return;
    }

    const isUnknown = (STATE.selectedSalt==="UNKNOWN");
    if (isUnknown && STATE.mode!=="expert"){
      log(`<span class="warn">Unbekannt A gibt es nur im Expertenmodus.</span>`);
      return;
    }
    if (isUnknown && !STATE.unknownActual){
      log(`<span class="warn">Unbekannt A ist noch nicht gesetzt.</span>`);
      return;
    }

    STATE.tube.has=true;
    STATE.tube.unknown=isUnknown;
    STATE.tube.saltId = isUnknown ? null : selectedActualSaltId();
    STATE.tube.dissolved=false;
    STATE.tube.ag=false;

    renderTubeSalt(true);

    const label = labelForPlacement(isUnknown, STATE.tube.saltId);
    setStatus(`Salz im Reagenzglas: ${label}`);
    log(`<span class="ok">Salz ins Reagenzglas gegeben.</span>`);
  });

  $$(".well").forEach(well=>{
    const i = Number(well.dataset.well);
    well.addEventListener("click", ()=>{
      if (!STATE.selectedSalt){ log(`<span class="warn">Zuerst ein Salz ausw√§hlen.</span>`); return; }
      const w = STATE.wells[i];
      if (w.has){ log(`<span class="warn">Feld ${i+1} ist bereits belegt.</span>`); return; }

      const isUnknown = (STATE.selectedSalt==="UNKNOWN");
      if (isUnknown && STATE.mode!=="expert"){
        log(`<span class="warn">Unbekannt A gibt es nur im Expertenmodus.</span>`);
        return;
      }
      if (isUnknown && !STATE.unknownActual){
        log(`<span class="warn">Unbekannt A ist noch nicht gesetzt.</span>`);
        return;
      }

      w.has=true;
      w.unknown=isUnknown;
      w.saltId = isUnknown ? null : selectedActualSaltId();
      renderWellSalt(i);
      setWellTag(i);

      const label = labelForPlacement(isUnknown, w.saltId);
      setStatus(`Salz auf Feld ${i+1}: ${label}`);
      log(`<span class="ok">Salz auf Feld ${i+1} gegeben.</span>`);
    });
  });

  $$(".wellReset").forEach(btn=>{
    btn.addEventListener("click",(ev)=>{
      ev.stopPropagation();
      const i = Number(btn.dataset.wreset);
      STATE.wells[i] = {has:false, saltId:null, unknown:false, hcl:false};
      const well = $(`.well[data-well="${i}"]`);
      $(".fluid", well).style.background = "transparent";
      const salt = $(".salt", well);
      salt.style.opacity="0";
      salt.innerHTML="";
      setWellTag(i);
      if (STATE.mgoDipped && STATE.mgoDipped.well===i) STATE.mgoDipped=null;
      log(`<span class="muted">Feld ${i+1} zur√ºckgesetzt.</span>`);
    });
  });

  btnResetAll.addEventListener("click", ()=>{
    STATE.selectedSalt=null;
    $$("#saltList .itemBtn").forEach(b=>b.classList.remove("active"));
    flameTint.classList.remove("show");
    STATE.burnerOn=false;
    STATE.mgoDipped=null;
    resetTube();
    for (let i=0;i<4;i++){
      const btn = $(`.wellReset[data-wreset="${i}"]`);
      btn.click();
    }
    setStatus("Bereit.");
    updateTop();
    log(`<span class="muted">Alles zur√ºckgesetzt.</span>`);
  });

  function arsenateSequence(){
    const seq = [
      {bg:"rgba(255,255,255,.40)", text:"wei√ülich"},
      {bg:"rgba(250,204,21,.40)",  text:"gelb"},
      {bg:"rgba(251,146,60,.40)",  text:"orange"},
      {bg:"rgba(120,53,15,.42)",   text:"braun"},
      {bg:"rgba(2,6,23,.55)",      text:"schwarz"}
    ];
    let idx=0;

    tubePrecip.style.height="28%";
    tubePrecip.style.background = seq[idx].bg;
    setStatus(`Arsenat-Niederschlag: ${seq[idx].text}`);

    stopArsenate();
    STATE.tube.arsenateTimer = setInterval(()=>{
      idx++;
      if (idx>=seq.length){
        stopArsenate();
        setStatus("Arsenat-Niederschlag: Endzustand (schwarz)");
        log(`<span class="ok">Arsenat: Farbabfolge abgeschlossen.</span>`);
        return;
      }
      tubePrecip.style.background = seq[idx].bg;
      setStatus(`Arsenat-Niederschlag: ${seq[idx].text}`);
    }, 650);
  }

  const TOOLS = [
    { id:"Wasser", kind:"water",  x: 16,  y: 16, title:"Wasser (H‚ÇÇO)" },
    { id:"AgNO3",  kind:"agno3",  x: 220, y: 16, title:"Pipette (AgNO‚ÇÉ)" },
    { id:"HCl",    kind:"hcl",    x: 424, y: 16, title:"Pipette (HCl)" },
    { id:"MgO",    kind:"mgo",    x: 628, y: 16, title:"MgO-St√§bchen" }
  ];

  /* (2) klassische Tropfpipette (Bulb + Schaft + Spitze + Tropfen) */
  function classicDropperSVG(label, dropletStroke){
    return `
      <svg viewBox="0 0 64 64" aria-hidden="true">
        <!-- Gummiball -->
        <ellipse cx="20" cy="18" rx="9" ry="9" fill="rgba(226,232,240,.18)" stroke="rgba(226,232,240,.40)" stroke-width="2"/>
        <!-- Glas-Schaft -->
        <path d="M26 22 L46 42" stroke="rgba(226,232,240,.55)" stroke-width="4" stroke-linecap="round"/>
        <!-- Spitze -->
        <path d="M46 42 L52 48" stroke="rgba(226,232,240,.35)" stroke-width="3" stroke-linecap="round"/>
        <!-- Tropfen -->
        <path d="M52 52c0 3-4 6-4 6s-4-3-4-6a4 4 0 0 1 8 0z"
              fill="rgba(255,255,255,.05)" stroke="${dropletStroke}" stroke-width="2"/>
        <!-- Etikett -->
        <rect x="28" y="30" width="20" height="12" rx="6"
              fill="rgba(2,6,23,.35)" stroke="rgba(226,232,240,.20)" stroke-width="2"/>
        <text x="38" y="39" text-anchor="middle" font-size="7" font-weight="800" fill="rgba(229,231,235,.95)">${label}</text>
      </svg>
    `;
  }

  function toolSVG(kind){
    if (kind==="water") return `
      <svg viewBox="0 0 64 64" aria-hidden="true">
        <path d="M18 10h28" stroke="rgba(226,232,240,.35)" stroke-width="2" />
        <path d="M20 12h24l3 8v28c0 6-5 10-11 10H28c-6 0-11-4-11-10V20l3-8z"
              fill="rgba(255,255,255,.06)" stroke="rgba(226,232,240,.35)" stroke-width="2" />
        <path d="M23 30c5 6 13 6 18 0" fill="none" stroke="rgba(147,197,253,.55)" stroke-width="2" stroke-linecap="round"/>
        <text x="32" y="45" text-anchor="middle" font-size="10" font-weight="800" fill="rgba(229,231,235,.95)">H‚ÇÇO</text>
      </svg>
    `;
    if (kind==="agno3") return classicDropperSVG("AgNO‚ÇÉ","rgba(147,197,253,.55)");
    if (kind==="hcl")   return classicDropperSVG("HCl","rgba(34,197,94,.55)");
    return `
      <svg viewBox="0 0 64 64" aria-hidden="true">
        <rect x="10" y="28" width="44" height="10" rx="5" fill="rgba(226,232,240,.20)" stroke="rgba(226,232,240,.35)" stroke-width="2"/>
        <rect x="44" y="26" width="10" height="14" rx="4" fill="rgba(226,232,240,.30)" stroke="rgba(226,232,240,.35)" stroke-width="2"/>
        <text x="18" y="35" font-size="8" font-weight="800" fill="rgba(229,231,235,.95)">MgO</text>
      </svg>
    `;
  }

  function rectOf(el){
    const r = el.getBoundingClientRect();
    return {x:r.left,y:r.top,w:r.width,h:r.height};
  }
  function pointIn(px,py,R){ return px>=R.x && px<=R.x+R.w && py>=R.y && py<=R.y+R.h; }
  function findWell(px,py){
    for (const w of $$(".well")){
      if (pointIn(px,py,rectOf(w))) return w;
    }
    return null;
  }
  function flameZone(){
    const r = rectOf(flame);
    return {x:r.x-12,y:r.y-12,w:r.w+24,h:r.h+24};
  }

  function getTubeChem(){
    if (!STATE.tube.has) return null;
    if (STATE.tube.unknown) return STATE.unknownActual;
    return SALTS[STATE.tube.saltId];
  }

  function applyDrop(kind, px, py){
    if (kind==="water"){
      if (!pointIn(px,py,rectOf(tube))){ log(`<span class="warn">Wasser: √ºber Reagenzglas loslassen.</span>`); return; }
      if (!STATE.tube.has){ log(`<span class="warn">Wasser: zuerst Salz ins Reagenzglas.</span>`); return; }
      if (STATE.tube.dissolved){ log(`<span class="warn">Wasser: bereits gel√∂st.</span>`); return; }
      STATE.tube.dissolved=true;
      tubeLiquid.style.height="44%";
      renderTubeSalt(false);
      setStatus("Wasser zugegeben ‚Üí Salz gel√∂st");
      log(`<span class="ok">Wasser ‚Üí gel√∂st.</span>`);
      return;
    }

    if (kind==="agno3"){
      if (!pointIn(px,py,rectOf(tube))){ log(`<span class="warn">AgNO‚ÇÉ: √ºber Reagenzglas loslassen.</span>`); return; }
      if (!STATE.tube.has || !STATE.tube.dissolved){ log(`<span class="warn">AgNO‚ÇÉ: erst Salz + Wasser im Reagenzglas.</span>`); return; }
      if (STATE.tube.ag){ log(`<span class="warn">AgNO‚ÇÉ: bereits zugegeben.</span>`); return; }
      STATE.tube.ag=true;

      const chem = getTubeChem();
      if (!chem){ return; }

      if (chem.ag==="white" || chem.ag==="cream" || chem.ag==="yellow"){
        stopArsenate();
        tubePrecip.style.height = (chem.ag==="white") ? "18%" : (chem.ag==="cream" ? "22%" : "28%");
        tubePrecip.style.background = AG_BG[chem.ag];
        setStatus(`AgNO‚ÇÉ: Niederschlag passend zum Anion`);
        log(`<span class="ok">AgNO‚ÇÉ ‚Üí Niederschlag.</span>`);
        return;
      }
      if (chem.ag==="arsenate"){
        arsenateSequence();
        log(`<span class="ok">AgNO‚ÇÉ ‚Üí Arsenat-Niederschlag (Farbabfolge) gestartet.</span>`);
        return;
      }
      return;
    }

    if (kind==="hcl"){
      const well = findWell(px,py);
      if (!well){ log(`<span class="warn">HCl: √ºber einer Mulde loslassen.</span>`); return; }
      const i = Number(well.dataset.well);
      const w = STATE.wells[i];
      if (!w.has){ log(`<span class="warn">HCl: zuerst Salz in die Mulde.</span>`); return; }
      if (w.hcl){ log(`<span class="warn">HCl: bereits zugegeben.</span>`); return; }
      w.hcl=true;
      $(".fluid", well).style.background="rgba(34,197,94,.10)";
      setWellTag(i);
      setStatus(`Mulde ${i+1}: mit HCl gel√∂st`);
      log(`<span class="ok">HCl ‚Üí Mulde ${i+1} gel√∂st.</span>`);
      return;
    }

    if (kind==="mgo"){
      const well = findWell(px,py);
      if (well){
        const i = Number(well.dataset.well);
        const w = STATE.wells[i];
        if (!w.has || !w.hcl){ log(`<span class="warn">MgO: erst Salz + HCl in der Mulde.</span>`); return; }
        STATE.mgoDipped = {well:i, unknown:w.unknown, saltId:w.saltId};
        setStatus(`MgO getaucht (Mulde ${i+1}). Jetzt in die Flamme.`);
        log(`<span class="ok">MgO ‚Üí getaucht.</span>`);
        return;
      }

      const F = flameZone();
      if (pointIn(px,py,F)){
        if (!STATE.burnerOn){ log(`<span class="warn">MgO in Flamme: Brenner ist aus.</span>`); return; }
        if (!STATE.mgoDipped){ log(`<span class="warn">MgO in Flamme: zuerst in gel√∂ste Probe tauchen.</span>`); return; }

        const chem = STATE.mgoDipped.unknown ? STATE.unknownActual : SALTS[STATE.mgoDipped.saltId];
        const flameName = chem.flame || "gelb";

        flameTint.style.background = FLAME_TINT[flameName] || FLAME_TINT["gelb"];
        flameTint.classList.add("show");

        setStatus(`Flammenprobe: ${flameName}`);
        log(`<span class="ok">Flammenfarbe: <b>${flameName}</b>.</span>`);
        return;
      }

      log(`<span class="warn">MgO: √ºber Mulde (tauchen) oder √ºber Flamme (Farbe) loslassen.</span>`);
      return;
    }
  }

  function makeDraggable(el){
    let dragging=false, sx=0, sy=0, ox=0, oy=0;
    el.addEventListener("pointerdown",(ev)=>{
      dragging=true;
      el.setPointerCapture(ev.pointerId);
      sx=ev.clientX; sy=ev.clientY;
      ox=parseFloat(el.style.left||"0");
      oy=parseFloat(el.style.top||"0");
      STATE.activeToolId = el.dataset.id;
      $$(".tool").forEach(t=>t.classList.toggle("selected", t===el));
      updateTop();
    });
    el.addEventListener("pointermove",(ev)=>{
      if (!dragging) return;
      const dx=ev.clientX-sx, dy=ev.clientY-sy;
      const benchRect=bench.getBoundingClientRect();
      const w=el.offsetWidth, h=el.offsetHeight;
      let nx=ox+dx, ny=oy+dy;
      nx=Math.max(6, Math.min(nx, benchRect.width-w-6));
      ny=Math.max(6, Math.min(ny, benchRect.height-h-6));
      el.style.left=nx+"px";
      el.style.top=ny+"px";
    });
    el.addEventListener("pointerup",(ev)=>{
      if (!dragging) return;
      dragging=false;
      applyDrop(el.dataset.kind, ev.clientX, ev.clientY);
    });
    el.addEventListener("pointercancel",()=>{ dragging=false; });
  }

  function createTool(t){
    const el=document.createElement("div");
    el.className="tool";
    el.dataset.kind=t.kind;
    el.dataset.id=t.id;
    el.style.left=t.x+"px";
    el.style.top=t.y+"px";
    el.innerHTML = `
      <div class="icon">${toolSVG(t.kind)}</div>
      <div class="lbl">
        <b>${t.title}</b>
        <small>Ziehen & loslassen</small>
      </div>`;
    toolStage.appendChild(el);
    makeDraggable(el);
  }

  TOOLS.forEach(createTool);

  for (let i=0;i<4;i++) setWellTag(i);

  updateTop();
  log(`<span class="muted">Start bereit.</span>`);
});
</script>
</body>
</html>

